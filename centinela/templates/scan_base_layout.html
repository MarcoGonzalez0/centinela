<!-- Tailwind no lo importo porque esta en index.html -->
{% load static %}
{% block extra_head %}
<script>
    window.Visuals = {}; // espacio de nombres global para gr√°ficos
</script>

<!-- Chart.js desde CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- cargamos los scripts de gr√°ficos -->
<script src="{% static 'js/charts/dns.js' %}"></script>
<!-- <script src="{% static 'js/charts/dorks.js' %}"></script>
<script src="{% static 'js/charts/headerhttp.js' %}"></script>
<script src="{% static 'js/charts/nmap.js' %}"></script>
<script src="{% static 'js/charts/ssl.js' %}"></script>
<script src="{% static 'js/charts/whois.js' %}"></script> -->

{% endblock %}

<!-- 4 Columnas -->
<div class="row g-3 justify-content-center" id="grid-modulos">

    <div class="col-12 col-sm-6 col-lg-3 border border-danger d-flex justify-content-center align-items-center" style="height: 15rem;">
        <h2 class="h4 m-0">MODULO DNS</h2>
    </div>

    <div class="col-12 col-sm-6 col-lg-3 border border-danger d-flex justify-content-center align-items-center" style="height: 15rem;">
        <h2 class="h4 m-0">MODULO NMAP</h2>
    </div>

    <div class="col-12 col-sm-6 col-lg-3 border border-danger d-flex justify-content-center align-items-center" style="height: 15rem;">
        <h2 class="h4 m-0">MODULO SSL</h2>
    </div>

    <div class="col-12 col-sm-6 col-lg-3 border border-danger d-flex justify-content-center align-items-center" style="height: 15rem;">
        <h2 class="h4 m-0">MODULO WHOIS</h2>
    </div>

</div>


<script>

    const rutaModulos = {
        'dns': 'dns_visuals.html',
        'dorks': 'dorks_visuals.html',
        'headerhttp': 'headerhttp_visuals.html',
        'nmap': 'nmap_visuals.html',
        'ssl': 'ssl_visuals.html',
        'whois': 'whois_visuals.html',
    };

    const nombreTargetElement = '#grid-modulos'; // Selector del contenedor donde se cargar√°n los m√≥dulos

    // aca va el polling
    (function(){
        const escaneoId = "{{ escaneo_id|default:'' }}";
        if (!escaneoId) return; // nada que vigilar

        const intervalMs = 3000; // poll cada 3s (ajusta si quieres)
        

        async function fetchResults(){
            try {
            const resp = await fetch(`resultadosmodulos/?escaneo_id=${escaneoId}`, {
                credentials: 'same-origin', // usa session auth
                headers: { 'Accept': 'application/json' }
            });
            if (!resp.ok) {
                console.error('API error', resp.status);
                return;
            }
            const data = await resp.json(); // array de resultados

             if (!Array.isArray(data) || data.length === 0) {
            console.warn("No se recibieron m√≥dulos todav√≠a");
            return;
            }
            // console.log("Resultados recibidos:", data);
            // console.log("Modulo recibido:", data[0].nombre_modulo, "‚Üí ruta:", rutaModulos[data[0].nombre_modulo]);

            // üëâ recorrer todos los m√≥dulos
            data.forEach(mod => {
                const ruta = rutaModulos[mod.nombre_modulo];
                if (!ruta) {
                    console.warn("No hay ruta definida para m√≥dulo:", mod.nombre_modulo);
                    return;
                }
                console.log("Modulo: ", mod)
                // Si ya existe el bloque de ese m√≥dulo, lo actualizamos en vez de volverlo a crear
                if (document.querySelector(`#mod-${mod.id}`)) {
                    console.log(`M√≥dulo ${mod.nombre_modulo} ya renderizado, se actualiza estado.`);
                } else if (mod.estado === "completado" && mod.resultado && Object.keys(mod.resultado).length > 0) {
                    console.log(`‚úÖ Cargando m√≥dulo ${mod.nombre_modulo} ‚Üí ${ruta}`);
                    loadHTML(ruta, nombreTargetElement, mod);
                } else {
                    console.log(`‚è≥ M√≥dulo ${mod.nombre_modulo} a√∫n en proceso, esperando resultados...`);
                }
            });


            // Actualizamos el estado del m√≥dulo en el frontend
            const moduleStatusElement = document.getElementById('module-status');
            if (moduleStatusElement) {
                moduleStatusElement.textContent = data.estado;
                if (data.estado === 'completado') {
                    moduleStatusElement.classList.remove('text-green-600', 'text-yellow-600', 'text-red-600');
                    moduleStatusElement.classList.add('text-green-600');
                } else if (data.estado === 'en_proceso') {
                    moduleStatusElement.classList.remove('text-green-600', 'text-yellow-600', 'text-red-600');
                    moduleStatusElement.classList.add('text-yellow-600');
                } else if (data.estado === 'error') {
                    moduleStatusElement.classList.remove('text-green-600', 'text-yellow-600', 'text-red-600');
                    moduleStatusElement.classList.add('text-red-600');
                }
            }

            const allFinished = data.length > 0 && data.every(r => r.estado === 'completado' || r.estado === 'error');
            if (allFinished) {
                clearInterval(poller);
                // opcional: mostrar toast o abrir modal
            }
            } catch (err) {
            console.error('fetch error', err);
            }
        }

        fetchResults(); // llamada inicial inmediata
        const poller = setInterval(fetchResults, intervalMs);
    
    })();



    //AUXILIARES
    // Funci√≥n para cargar HTML externo y traer los visuals de cada modulo
    async function loadHTML(file, targetElement, data) {
        try {
            const response = await fetch(`modules/${file}`);
            const html = await response.text();

            // Crear un contenedor din√°mico para este m√≥dulo
            const wrapper = document.createElement("div");
            //wrapper.classList.add("col-span-1"); // ocupa una columna
            wrapper.id = `mod-${data.id}`; // id √∫nico por m√≥dulo
            wrapper.innerHTML = html;

            // Agregarlo al grid (appendChild en vez de innerHTML =)
            document.querySelector(targetElement).appendChild(wrapper);

            setTimeout(() => {
                // Llamo a la funci√≥n del m√≥dulo que inicializa los gr√°ficos
                const modulo = data.nombre_modulo; // ej "dns"
                if (window.Visuals && typeof window.Visuals[modulo] === 'function') { //Si puede acceder a windows.visuals y existe la funci√≥n
                    console.log(`Iniciando gr√°ficos para m√≥dulo ${modulo}`, data.resultado);
                    window.Visuals[modulo](data.resultado); // paso los datos JSON
                } else {
                    console.warn(`No se encontr√≥ funci√≥n de inicializaci√≥n para m√≥dulo ${modulo}`);
                }
                
            }, 100);

        } catch (error) {
            console.error('Error cargando el archivo:', error);
        }
    }
</script>