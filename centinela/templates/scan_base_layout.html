<!-- Tailwind no lo importo porque esta en index.html -->


<!-- 4 Columnas -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 justify-center">
</div>

<script>
    // HAY ERRORES AQUI SOLUCIONARLOS
    const rutaModulos = {
        'dns': '/modules/dns_visuals.html',
        'dorks': '/modules/dorks_visuals.html',
        'headerhttp': '/modules/headerhttp_visuals.html',
        'nmap': '/modules/nmap_visuals.html',
        'ssl': '/modules/ssl_visuals.html',
        'whois': '/modules/whois_visuals.html',
    };

    const nombreTargetElement = '.grid'; // Selector del contenedor donde se cargar√°n los m√≥dulos

    // aca va el polling
    (function(){
        const escaneoId = "{{ escaneo_id|default:'' }}";
        if (!escaneoId) return; // nada que vigilar

        const intervalMs = 3000; // poll cada 3s (ajusta si quieres)
        

        async function fetchResults(){
            try {
            const resp = await fetch(`resultadosmodulos/?escaneo_id=${escaneoId}`, {
                credentials: 'same-origin', // usa session auth
                headers: { 'Accept': 'application/json' }
            });
            if (!resp.ok) {
                console.error('API error', resp.status);
                return;
            }
            const data = await resp.json(); // array de resultados

             if (!Array.isArray(data) || data.length === 0) {
            console.warn("No se recibieron m√≥dulos todav√≠a");
            return;
            }
            console.log("Resultados recibidos:", data);
            console.log("Modulo recibido:", data[0].nombre_modulo, "‚Üí ruta:", rutaModulos[data[0].nombre_modulo]);

            // üëâ recorrer todos los m√≥dulos
            data.forEach(mod => {
                const ruta = rutaModulos[mod.nombre_modulo];
                if (!ruta) {
                    console.warn("No hay ruta definida para m√≥dulo:", mod.nombre_modulo);
                    return;
                }
                // Si ya existe el bloque de ese m√≥dulo, lo actualizamos en vez de volverlo a crear
                if (document.querySelector(`#mod-${mod.id}`)) {
                    console.log(`M√≥dulo ${mod.nombre_modulo} ya renderizado, se actualiza estado.`);
                    // ac√° podr√≠as actualizar gr√°ficos en vez de re-crear
                } else {
                    console.log(`Cargando m√≥dulo ${mod.nombre_modulo} ‚Üí ${ruta}`);
                    loadHTML(ruta, nombreTargetElement, mod);
                }
            });


            // Actualizamos el estado del m√≥dulo en el frontend
            const moduleStatusElement = document.getElementById('module-status');
            if (moduleStatusElement) {
                moduleStatusElement.textContent = data.estado;
                if (data.estado === 'completado') {
                    moduleStatusElement.classList.remove('text-green-600', 'text-yellow-600', 'text-red-600');
                    moduleStatusElement.classList.add('text-green-600');
                } else if (data.estado === 'en_proceso') {
                    moduleStatusElement.classList.remove('text-green-600', 'text-yellow-600', 'text-red-600');
                    moduleStatusElement.classList.add('text-yellow-600');
                } else if (data.estado === 'error') {
                    moduleStatusElement.classList.remove('text-green-600', 'text-yellow-600', 'text-red-600');
                    moduleStatusElement.classList.add('text-red-600');
                }
            }

            const allFinished = data.length > 0 && data.every(r => r.estado === 'completado' || r.estado === 'error');
            if (allFinished) {
                clearInterval(poller);
                // opcional: mostrar toast o abrir modal
            }
            } catch (err) {
            console.error('fetch error', err);
            }
        }

        fetchResults(); // llamada inicial inmediata
        const poller = setInterval(fetchResults, intervalMs);
    
    })();






    //AUXILIARES
    // Funci√≥n para cargar HTML externo y traer los visuals de cada modulo
    async function loadHTML(file, targetElement, data) {
        try {
            const response = await fetch(file);
            const html = await response.text();

            // Crear un contenedor din√°mico para este m√≥dulo
            const wrapper = document.createElement("div");
            wrapper.classList.add("col-span-1"); // ocupa una columna
            wrapper.id = `mod-${data.id}`; // id √∫nico por m√≥dulo
            wrapper.innerHTML = html;

            // Agregarlo al grid (appendChild en vez de innerHTML =)
            document.querySelector(targetElement).appendChild(wrapper);

            setTimeout(() => {
                // Llamo a la funci√≥n del m√≥dulo que inicializa los gr√°ficos
                initGraficos(data);
            }, 100);

        } catch (error) {
            console.error('Error cargando el archivo:', error);
        }
    }


// Uso
//loadHTML('modulos/card.html', '.grid');
</script>